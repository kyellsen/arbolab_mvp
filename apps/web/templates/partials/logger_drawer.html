<div class="h-full flex flex-col" 
     x-data="logDrawer()"
     x-init="init()"
     x-effect="logDrawerOpen ? startPolling() : stopPolling()">
    <!-- Header with Tabs -->
    <div class="flex items-center justify-between p-2 border-b border-slate-700 bg-slate-800">
        <div class="flex items-center gap-1">
            <!-- Tab Buttons -->
            <template x-if="config.recipeEnabled">
                <button @click="activeTab = 'recipe'" 
                        :class="activeTab === 'recipe' ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700/50'"
                        class="px-3 py-1.5 rounded text-xs font-medium transition-colors">
                    Recipe
                </button>
            </template>
            <template x-if="config.systemEnabled">
                <button @click="activeTab = 'system'" 
                        :class="activeTab === 'system' ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700/50'"
                        class="px-3 py-1.5 rounded text-xs font-medium transition-colors">
                    System
                </button>
            </template>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- Status indicator -->
            <span x-show="polling" class="flex items-center gap-1 text-xs text-slate-500">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                Live
            </span>
            
            <!-- Clear button -->
            <button @click="clearLogs()" class="text-slate-500 hover:text-slate-300 text-xs px-2">
                Clear
            </button>
            
        </div>
    </div>
    
    <!-- Log Content -->
    <div class="flex-1 overflow-y-auto p-3 font-mono text-xs space-y-0.5 bg-black" id="log-container">
        <template x-if="logs.length === 0">
            <div class="text-slate-600 italic">No logs yet...</div>
        </template>
        
        <template x-for="log in logs" :key="log.timestamp + log.message">
            <div class="flex gap-2 py-0.5 hover:bg-slate-900/50 px-1 rounded">
                <!-- Timestamp -->
                <span class="text-slate-600 shrink-0" x-text="formatTime(log.timestamp)"></span>
                
                <!-- Level Badge -->
                <span :class="{
                    'text-blue-400': log.level === 'info',
                    'text-yellow-500': log.level === 'warn',
                    'text-red-500': log.level === 'error',
                    'text-slate-500': log.level === 'debug'
                }" class="shrink-0 uppercase w-12" x-text="log.level"></span>
                
                <!-- Source Badge (only if showing all tabs) -->
                <template x-if="!activeTab">
                    <span class="text-slate-600 shrink-0" x-text="'[' + log.source + ']'"></span>
                </template>
                
                <!-- Message -->
                <div class="min-w-0 flex flex-col">
                    <span class="text-green-400" x-text="log.message"></span>
                    <template x-if="hasParams(log.params)">
                        <span class="text-slate-500 whitespace-pre-wrap break-words" 
                              x-text="formatParams(log.params)"></span>
                    </template>
                </div>
            </div>
        </template>
    </div>
</div>

<script>
function logDrawer() {
    return {
        activeTab: 'recipe',  // Default tab
        logs: [],
        polling: false,
        pollInterval: null,
        lastTimestamp: null,
        config: {
            recipeEnabled: true, 
            systemEnabled: true,
            pollIntervalMs: 3000
        },
        
        init() {
            // Load config from backend
            this.loadConfig();
        },
        
        async loadConfig() {
            try {
                const response = await fetch('/api/logs/config');
                if (response.ok) {
                    this.config = await response.json();
                    // Set default active tab to first enabled
                    if (this.config.recipeEnabled) this.activeTab = 'recipe';
                    else if (this.config.systemEnabled) this.activeTab = 'system';
                }
            } catch (e) {
                console.error('Failed to load log config:', e);
            }
        },
        
        startPolling() {
            if (this.pollInterval) return;
            
            this.polling = true;
            this.fetchLogs(); // Initial fetch
            
            this.pollInterval = setInterval(() => {
                this.fetchLogs();
            }, this.config.pollIntervalMs);
        },
        
        stopPolling() {
            if (this.pollInterval) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
            }
            this.polling = false;
        },
        
        async fetchLogs() {
            try {
                const drawer = document.getElementById('logger-drawer');
                if (!drawer || window.getComputedStyle(drawer).display === 'none') {
                    return;
                }

                // Always fetch without since filter for now (simpler, works)
                let url = `/api/logs?tab=${this.activeTab}`;
                
                console.log('[LogDrawer] Fetching:', url);
                
                const response = await fetch(url, {
                    credentials: 'same-origin'  // Send session cookies
                });
                console.log('[LogDrawer] Response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('[LogDrawer] Got logs:', data.logs?.length || 0);
                    
                    // Always replace logs with fresh data
                    this.logs = data.logs || [];
                    this.lastTimestamp = data.timestamp;
                } else {
                    console.error('[LogDrawer] Bad response:', response.status);
                    // If auth fails, show error in logs
                    if (response.status === 401) {
                        this.logs = [{
                            timestamp: new Date().toISOString(),
                            level: 'error',
                            source: 'system',
                            message: 'Not authenticated - please login'
                        }];
                    }
                }
            } catch (e) {
                console.error('[LogDrawer] Failed to fetch logs:', e);
                this.logs = [{
                    timestamp: new Date().toISOString(),
                    level: 'error',
                    source: 'system',
                    message: `Fetch error: ${e.message}`
                }];
            }
        },
        
        formatTime(timestamp) {
            if (!timestamp) return '--:--:--';
            const date = new Date(timestamp);
            return date.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
        },

        hasParams(params) {
            return params && typeof params === 'object' && Object.keys(params).length > 0;
        },

        formatParams(params) {
            if (!params) return '';
            try {
                return JSON.stringify(params);
            } catch (e) {
                return String(params);
            }
        },
        
        clearLogs() {
            this.logs = [];
            this.lastTimestamp = null;
        }
    };
}

</script>
